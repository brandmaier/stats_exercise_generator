---
title: "Arbeitsblatt - Korrelation"
author: "Statistik II - Andreas M. Brandmaier"
date: "`r format(Sys.time(), '%d. %B %Y')`"
output:
  pdf_document: 
    extra_dependencies: ["float","breqn","amsmath"]
  html_document: default
params:
  include_solution: true
---
```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(psych)
library(patchwork)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "") # prevent LaTeX tables from floating around

source("R/helper.R")


include_solution <- params$include_solution

empty_str <- "\\ "


rport <- function(x) {pval=round(x$p.value,3); if (pval<0.001)pval="<0.001"; paste0("r=",round(x$estimate,3)," (p=",pval,")")}

```

## Korrelation


## Aufgabe 1
Mit Hilfe des Datensatzes "bfi" aus dem R-Paket `psych` wurde untersucht, inwieweit
es eine Korrelation zwischen Gewissenhaftigkeit und Alter gibt. Dazu wurde
das Lebensalter in Jahren mit einer Summe von fünf Likert-Skalen, die das Persönlichkeitsmerkmal
Gewissenhaftigkeit erfragen (Bsp: "Ich höre nicht auf bevor ich etwas beendet habe") korreliert.
Die beobachteten Datenpunkte und eine Linie, die den linearen Zusammenhang verdeutlicht sind in folgender Abbildung dargestellt:

```{r}
cnt <- bfi[,6]+bfi[,7]+bfi[,8]+7-bfi[,9]+7-bfi[,10]
ctest = cor.test(cnt, bfi$age)
df = data.frame(conscientousness=cnt,age=bfi$age)
```

```{r plot, warning=FALSE, message=FALSE, fig.width=6, fig.height=3}
ggplot2::ggplot(df,aes(y=conscientousness,x=age))+geom_point()+theme_minimal()+
  geom_smooth(method = "lm")+ylab("Gewissenhaftigkeit")+xlab("Alter")
```

Es ergab sich eine Korrelation von `r rport(ctest)`. Wie interpretieren Sie
dieses Ergebnis?


```{r results="asis", eval=include_solution}
cat(solution_header())

cat("Es zeigte sich ein positiver Zusammenhang, der signifikant von Null verschieden war. Dieser positive Zusammenhang bedeutet, dass ältere Personen in der Stichprobe auch gewissenhafter sind. Einzuschränken ist hier, dass es sich um querschnittliche Daten handelt, d.h., dieser Effekt könnte nicht in Wirklichkeit auf Unterschiede im Alter, sondern auf Kohortenunterschiede zurückzuführen sein (d.h., Unterschiede in den verschiedenen Geburtsjahrgängen). Laut Cohen's Definition handelt es sich hier um einen schwachen Zusammenhang ($r\\approx0.1$).")

```

## Aufgabe 2
```{r}
set.seed(3498)
n <- 25
smp <- function(){ 
  MASS::mvrnorm(n=25, 
                mu=c(0,0), 
                Sigma=matrix(c(1,0.2,0.2,1),nrow=2)
                )}
d1 = smp()
d2 = smp()

n1 = 25
n2 = 25

tst1 = cor.test(d1[,1],d1[,2])
tst2 = cor.test(d2[,1],d2[,2])

sig1 = ifelse(tst1$p.value<0.05,"signifikanter","nicht-signifikanter")
sig2 = ifelse(tst2$p.value<0.05,"signifikanter","nicht-signifikanter")

```

Im Rahmen einer empirischen Studie  wurde untersucht, inwieweit sich Persönlichkeitsmerkmale
auf den erlebten Stress im Studium auswirken. Dabei wurden zwei Kohorten von 
Erstsemestern untersucht, die in verschiedenen Jahren mit dem Studium begonnen haben. In
jeder Kohorte wurden 25 Studierende befragt.
In der Kohorte "A" wurde ein `r sig1` Zusammenhang von `r rport(tst1)` gefunden. In der
Kohorte "B" wurde ein `sig 2` Zusammenhang von `r rport(tst2)`gefunden.

Wie können wir untersuchen, ob sich der Zusammenhang zwischen den Kohorten unterscheidet? Führen
Sie alle notwendigen Schritte durch.


```{r results="asis", eval=include_solution}
cat(solution_header())

cat("Wir benutzen die Fisher's z-Transformation und führen dann den Test auf Verschiedenheit zweier Korrelationen durch")

z1 = round(psych::fisherz(tst1$estimate), 2 )
z2 = round(psych::fisherz(tst2$estimate), 2)

cat("Zunächst Berechnung der Fisher's Z-Werte:\n")
cat("r=",tst1$estimate, " entspricht ", z1,"\n")
cat("r=",tst2$estimate, " entspricht ", z2,"\n")

cat("Einsetzen in Formel:\n")
cat("$$Z=\\frac{",z1,"-",z2,"}{\\sqrt{","\\frac{1}{",n1,"-3}+\\frac{1}{",n2,"-3}","}}$$\n")
zdiff = (z1-z2) / sqrt(1/(n1-3)+1/(n2-3))

zdiff = round( zdiff, 2)

zkrit = round(qnorm(0.975),2)

cat("Der empirische z-Wert ist ",zdiff,"\n")
cat("Der kritische z-Wert (5%; zweiseitig) ist 1.96\n")
cat("Da wir zweiseitig testen, prüfen wir ob der Betrag des empirischen z-Werts größer als der kritische Wert ist. Dies ist nicht der Fall. Die Nullhypothese wird beibehalten. Es gibt keinen signifikanten Unterschied zwischen den beiden Kohorten.\n")

```


## Aufgabe 3

```{r}
knitr::include_graphics("img/correlation.png")

```



(Quelle: xkcd.com; R. Munroe; verfügbar unter folgender Lizenz Attribution-NonCommercial 2.5 Generic (CC BY-NC 2.5))

Was ist hier so lustig? Falls Sie das nicht lustig finden, senden Sie mir bitte witzigere Comics, Memes, o.ä. zu diesem Thema per E-Mail an [andreas.brandmaier@medicalschool-berlin.de](andreas.brandmaier@medicalschool-berlin.de).

```{r results="asis", eval=include_solution}
cat(solution_header())

cat("Eine Person erzählt der anderen, dass sie bisher immer dachte, dass eine Korrelation zwischen zwei Variablen bedeute, dass die eine Variable die andere kausal, also ursächlich, beinflusse. Im zweiten Panel erzählt sie weiter, dass sie in ihrer Statistik-Vorlesung gelernt habe, dass diese Implikation im Allgemeinen aber gar nicht stimme. Daraufhin entgegnet die linke Person, dass der Besuch der Statistik-Vorlesung also etwas gebracht hätte (im Sinne eines Lernerfolgs). Darauhin meint die erste Person: 'Nunja, vielleicht'. Der Witz besteht also darin, dass die erzählende Person in der Tat einen Lernerfolg hatte und nun so stark verinnerlicht hat, dass eine beobachtete Korrelation nicht gleich einem ursächlichen Zusammenhang ist, dass sie in Frage stellt, ob wirklich der Besuch der Vorlesung ursächlich für diese Erkenntnis war (da Erkenntnisgewinn und Vorlesungsbesuch von außen betrachtet zunächst lediglich korrelieren")
```

## Aufgabe 4

Gegeben sei der sogenannte Anscombe-Datensatz von Francis Anscombe (1973):

```{r}
dat <- datasets::anscombe

knitr::kable(dat)
```
Berechnen Sie die Korrelationen jeweils von
x1 und y1, von x2 und y2, von x3 und y3 und von x4 und y4. Wenn Sie dazu SPSS nutzen möchten, laden Sie den Datensatz "AB6-Korrelation-Anscombe.csv". Was schließen Sie daraus? 

```{r}
write.csv("AB6-Korrelation-Anscombe.csv",x = dat, quote=FALSE, row.names = FALSE)
```

Erstellen Sie einen Scatterplot der vier Variablenpaare. Inwiefern revidieren Sie Ihre Beurteilung?

```{r results="asis", eval=include_solution, message=FALSE, warning=FALSE}
cat(solution_header())
ct1 = cor.test(dat$x1, dat$y1)
ct2 = cor.test(dat$x2, dat$y2)
ct3 = cor.test(dat$x3, dat$y3)
ct4 = cor.test(dat$x4, dat$y4)
                                             
report_corr <- function(x,i) { cat(paste0("Wir finden für das Paar X",i," und Y",i," einen Zusammenhang von ",rport(x),".\n")) }

q1 <- qplot(dat$x1,dat$y1)+geom_point(size=3)+xlab("X1")+ylab("Y1") + geom_smooth(method="lm")
q2 <- qplot(dat$x2,dat$y2)+geom_point(size=3)+xlab("X2")+ylab("Y2") + geom_smooth(method="lm")
q3 <- qplot(dat$x3,dat$y3)+geom_point(size=3)+xlab("X3")+ylab("Y3") + geom_smooth(method="lm")
q4 <- qplot(dat$x4,dat$y4)+geom_point(size=3)+xlab("X4")+ylab("Y4") + geom_smooth(method="lm")

(q1 + q2) / (q3 + q4)

report_corr(ct1,1)
report_corr(ct2,2)
report_corr(ct3,3)
report_corr(ct4,4)

cat("Es fällt auf, dass die Korrelationskoeffizienten nahezu exakt gleich sind, obwohl die Daten offenbar aus sehr unterschiedlichen Modellen stammen. Die Daten in den Scatterplots legen nahe, dass eine einfache Extrapolation aus den gegebenen Daten auf neue Daten nicht ohne Weiteres möglich ist. Es zeigt sich insbesondere, dass kleine p-Werte kein Beweis für die Korrektheit des Modells sind (siehe z.B. das quadratische Modell oben rechts oder das Modell mit dem Ausreißer unten rechts).")
```
